// Generated by CoffeeScript 1.4.0
var __hasProp = {}.hasOwnProperty,
  __extends = function(child, parent) { for (var key in parent) { if (__hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; };

(function(root, factory) {
  if (typeof define === 'function' && define.amd) {
    return define(['backbone', 'underscore'], function(Backbone, _) {
      return root.Backbone.SM2 = factory(Backbone, _);
    });
  } else {
    return root.Backbone.SM2 = factory(root.Backbone, root._);
  }
})(this, function(Backbone, _) {
  var Player, PlayerView;
  Player = (function() {

    _.extend(Player.prototype, Backbone.Events);

    function Player() {
      this.sound = void 0;
      this.queue = [];
      this.current = -1;
    }

    Player.prototype.add = function(playable) {
      this.queue.push(playable);
      return this.trigger('queue:add', playable);
    };

    Player.prototype.isActive = function(playable, playState) {
      var _ref, _ref1, _ref2;
      if (playState == null) {
        playState = 0;
      }
      if (playable) {
        return ((_ref = this.sound) != null ? _ref.playState : void 0) === playState && ((_ref1 = this.sound) != null ? _ref1.id : void 0) === playable.id;
      } else {
        return ((_ref2 = this.sound) != null ? _ref2.playState : void 0) === playState;
      }
    };

    Player.prototype.isPlaying = function(playable) {
      var _ref;
      return this.isActive(playable, 1) && !((_ref = this.sound) != null ? _ref.paused : void 0);
    };

    Player.prototype.isPaused = function(playable) {
      var _ref;
      return this.isActive(playable, 1) && ((_ref = this.sound) != null ? _ref.paused : void 0);
    };

    Player.prototype.play = function() {
      var playable,
        _this = this;
      if (this.isPlaying()) {
        return;
      }
      if (this.sound != null) {
        this.sound.play();
      } else {
        playable = this.getNext();
        if (!playable) {
          this.trigger('queue:end');
          return;
        }
        this.sound = soundManager.createSound({
          id: playable.id,
          url: _.isFunction(playable.url) ? playable.url : playable.url,
          onload: function() {
            _this.trigger('track:playStart', playable, _this.sound);
            _this.sound.play();
            return _this.preloadNext(_this.sound);
          },
          onfinish: function() {
            _this.trigger('track:finish', playable, _this.sound);
            return _this.next();
          }
        });
        this.sound.playable = playable;
        this.sound.load();
      }
      this.trigger('track:play', playable, this.sound);
      return this.sound;
    };

    Player.prototype.preloadNext = function(sound) {};

    Player.prototype.pause = function() {
      if (this.sound == null) {
        return;
      }
      this.sound.pause();
      return this.trigger('track:pause', this.sound.playable, this.sound);
    };

    Player.prototype.stop = function(destruct) {
      if (destruct == null) {
        destruct = false;
      }
      if (this.sound == null) {
        return;
      }
      this.sound.stop();
      this.trigger('track:stop', this.sound.playable, this.sound);
      if (destruct) {
        this.sound.destruct();
        return this.sound = void 0;
      }
    };

    Player.prototype.next = function() {
      if (this.sound == null) {
        return;
      }
      this.trigger('track:skip', this.sound.playable, this.sound);
      if (this.sound != null) {
        this.stop(true);
      }
      return this.play();
    };

    Player.prototype.setPosition = function(position, relative) {
      if (relative == null) {
        relative = false;
      }
      if (this.sound == null) {
        return;
      }
      position = relative ? this.sound.position + position : position;
      return this.sound.setPosition(position);
    };

    Player.prototype.pop = function() {
      var peek, playable, playlist;
      if (this.queue.length === 0) {
        return;
      }
      peek = this.queue[0];
      playable = _.isArray(this.queue[0]) ? (playlist = peek.length === 1 ? this.queue.shift(1) : this.queue[0], playlist.shift(1)) : this.queue.shift(1);
      this.trigger('queue:pop', playable);
      return playable;
    };

    Player.prototype.getNext = function() {
      var next;
      if (this.queue.length === 0) {
        return;
      }
      if (_.isArray(this.current)) {
        next = this.queue[this.current[0]][this.current[1] + 1];
        if (next) {
          this.current[1]++;
        } else {
          next = this.queue[this.current[0] + 1];
          this.current = this.current[0] + 1;
        }
      } else {
        next = this.queue[++this.current];
      }
      if (_.isArray(next)) {
        next = next[0];
        if (!_.isArray(this.current)) {
          this.current = [this.current, 0];
        }
      }
      this.trigger('queue:next', next);
      return next;
    };

    Player.prototype.isPlayable = function(playable) {
      return (playable != null) && playable.url && playable.id;
    };

    Player.prototype.ensureSM2 = function() {
      if (!soundManager.ok()) {
        throw new Events("SoundManager2 isn't ready");
      }
    };

    return Player;

  })();
  PlayerView = (function(_super) {

    __extends(PlayerView, _super);

    function PlayerView() {
      return PlayerView.__super__.constructor.apply(this, arguments);
    }

    PlayerView.prototype.className = 'app';

    PlayerView.prototype.initialize = function(options) {
      this.player = (options != null ? options.player : void 0) || new Player();
      if (!(options != null ? options.disablePlayerEvents : void 0)) {
        return this.listenTo(this.player, {
          'track:play': this.onPlay,
          'track:stop': this.onStop,
          'track:pause': this.onPause,
          'queue:add queue:pop': this.onQueueChange
        });
      }
    };

    PlayerView.prototype.onPlay = function() {};

    PlayerView.prototype.onStop = function() {};

    PlayerView.prototype.onPause = function() {};

    PlayerView.prototype.onQueueChange = function() {};

    return PlayerView;

  })(Backbone.View);
  return {
    Player: Player,
    PlayerView: PlayerView
  };
});
